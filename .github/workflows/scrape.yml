name: Run AppStore Scraper

on:
  workflow_dispatch:        # позволява ръчно стартиране от GitHub
  schedule:
    - cron: "0 4 * * *"     # всеки ден в 05:00 UTC (~08:00 българско време)

jobs:
  run-scraper:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt || echo "no requirements.txt found"
          pip install beautifulsoup4 requests lxml google-auth-oauthlib google-api-python-client

      - name: Download latest database from Google Drive
        env:
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          GOOGLE_CREDS_JSON: ${{ secrets.GOOGLE_CREDS_JSON }}
        run: |
          echo "Downloading latest app_data.db from Drive..."
          python utils/download_from_drive.py

      # --- СКРЕЙП Apps категории ---
      - name: Run Apps Scraper
        run: python scraper/scraper_apps.py

      # --- СКРЕЙП Games подкатегории ---
      - name: Run Games Scraper
        run: python scraper/scraper_games.py

      # --- Обединяване и експортиране на CSV ---
      - name: Merge Results
        run: python scraper/merge_results.py

      - name: Ensure DB schema
        env:
          DB_PATH: appstore-api/data/app_data.db
        run: |
          python utils/init_db.py


      # --- Качване в Google Drive (ако файлът съществува) ---
      - name: Upload database to Google Drive
        env:
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          GOOGLE_CREDS_JSON: ${{ secrets.GOOGLE_CREDS_JSON }}
        run: |
          if [ -f "utils/upload_to_drive.py" ]; then
            echo "Uploading database to Google Drive..."
            python utils/upload_to_drive.py
          else
            echo "⚠️ upload_to_drive.py not found — skipping Google upload."
          fi

      # --- Потвърждение ---
      - name: Finish
        run: echo "✅ Scraper run completed successfully!"
